<!DOCTYPE html>
<html class="light" dir="rtl" lang="ar">

<head>
    <%- include('../../../partials/head') %>
        <title>إدارة الاشتراكات - لوحة التحكم</title>
</head>

<body class="bg-background-light dark:bg-background-dark text-[#181113] dark:text-white transition-colors duration-200">
    <%- include('../../../partials/alerts') %>

        <div class="relative flex min-h-screen w-full">
            <%- include('../../../partials/sidebar', { role: 'admin' }) %>

                <main class="flex-1 p-8 mr-64">
                    <div class="max-w-7xl mx-auto space-y-8">
                        <!-- Header -->
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-4xl font-black mb-2">إدارة الاشتراكات</h1>
                                <p class="text-[#896170] dark:text-gray-400">متابعة وإدارة اشتراكات جميع الصالونات</p>
                            </div>

                            <!-- Stats Summary -->
                            <div class="flex items-center gap-4">
                                <div class="text-center p-4 bg-green-500/10 rounded-2xl border border-green-500/20">
                                    <div class="text-2xl font-black text-green-500">
                                        <%= stats.active %>
                                    </div>
                                    <div class="text-xs font-bold text-green-600">نشط</div>
                                </div>
                                <div class="text-center p-4 bg-orange-500/10 rounded-2xl border border-orange-500/20">
                                    <div class="text-2xl font-black text-orange-500">
                                        <%= stats.expiring %>
                                    </div>
                                    <div class="text-xs font-bold text-orange-600">ينتهي قريباً</div>
                                </div>
                                <div class="text-center p-4 bg-red-500/10 rounded-2xl border border-red-500/20">
                                    <div class="text-2xl font-black text-red-500">
                                        <%= stats.expired %>
                                    </div>
                                    <div class="text-xs font-bold text-red-600">منتهي</div>
                                </div>
                            </div>
                        </div>

                        <!-- Salons List -->
                        <div
                            class="bg-white dark:bg-[#2d1a22] rounded-3xl border-2 border-[#e6dbdf] dark:border-[#3d252e] overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50 dark:bg-[#1a0c10]">
                                        <tr>
                                            <th
                                                class="px-6 py-4 text-right text-xs font-black text-[#896170] dark:text-gray-400 uppercase tracking-wider">
                                                الصالون</th>
                                            <th
                                                class="px-6 py-4 text-right text-xs font-black text-[#896170] dark:text-gray-400 uppercase tracking-wider">
                                                المالك</th>
                                            <th
                                                class="px-6 py-4 text-center text-xs font-black text-[#896170] dark:text-gray-400 uppercase tracking-wider">
                                                الحالة</th>
                                            <th
                                                class="px-6 py-4 text-center text-xs font-black text-[#896170] dark:text-gray-400 uppercase tracking-wider">
                                                الأيام المتبقية</th>
                                            <th
                                                class="px-6 py-4 text-center text-xs font-black text-[#896170] dark:text-gray-400 uppercase tracking-wider">
                                                تاريخ الانتهاء</th>
                                            <th
                                                class="px-6 py-4 text-center text-xs font-black text-[#896170] dark:text-gray-400 uppercase tracking-wider">
                                                أيام الهدايا</th>
                                            <th
                                                class="px-6 py-4 text-center text-xs font-black text-[#896170] dark:text-gray-400 uppercase tracking-wider">
                                                إجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-[#e6dbdf] dark:divide-[#3d252e]">
                                        <% salons.forEach(function(salon) { const today=new Date(); const subEnd=new
                                            Date(salon.subscription_end); const daysLeft=Math.ceil((subEnd - today) /
                                            (1000 * 60 * 60 * 24)); const isExpiringSoon=daysLeft <=7 && daysLeft> 0;
                                            const isExpired = daysLeft <= 0; %>
                                                <tr class="hover:bg-gray-50 dark:hover:bg-[#1a0c10] transition-colors">
                                                    <!-- Salon Info -->
                                                    <td class="px-6 py-4">
                                                        <div class="flex items-center gap-3">
                                                            <img src="<%= salon.image_url %>" alt="<%= salon.name %>"
                                                                class="size-12 rounded-xl object-cover">
                                                            <div>
                                                                <div class="font-black text-sm">
                                                                    <%= salon.name %>
                                                                </div>
                                                                <div class="text-xs text-[#896170] dark:text-gray-400">
                                                                    <%= salon.location %>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </td>

                                                    <!-- Owner Info -->
                                                    <td class="px-6 py-4">
                                                        <div class="text-sm font-bold">
                                                            <%= salon.owner_name %>
                                                        </div>
                                                        <div class="text-xs text-[#896170] dark:text-gray-400">
                                                            <%= salon.owner_email %>
                                                        </div>
                                                    </td>

                                                    <!-- Status -->
                                                    <td class="px-6 py-4 text-center">
                                                        <% if (isExpired) { %>
                                                            <span
                                                                class="inline-flex px-3 py-1 bg-red-500/10 text-red-500 rounded-full text-xs font-black border border-red-500/20">
                                                                منتهي
                                                            </span>
                                                            <% } else if (isExpiringSoon) { %>
                                                                <span
                                                                    class="inline-flex px-3 py-1 bg-orange-500/10 text-orange-500 rounded-full text-xs font-black border border-orange-500/20">
                                                                    ينتهي قريباً
                                                                </span>
                                                                <% } else { %>
                                                                    <span
                                                                        class="inline-flex px-3 py-1 bg-green-500/10 text-green-500 rounded-full text-xs font-black border border-green-500/20">
                                                                        نشط
                                                                    </span>
                                                                    <% } %>
                                                    </td>

                                                    <!-- Days Left -->
                                                    <td class="px-6 py-4 text-center">
                                                        <div
                                                            class="text-2xl font-black <%= isExpired ? 'text-red-500' : isExpiringSoon ? 'text-orange-500' : 'text-green-500' %>">
                                                            <%= Math.max(0, daysLeft) %>
                                                        </div>
                                                        <div class="text-xs text-[#896170] dark:text-gray-400">يوم</div>
                                                    </td>

                                                    <!-- End Date -->
                                                    <td class="px-6 py-4 text-center">
                                                        <div class="text-sm font-bold">
                                                            <%= new
                                                                Date(salon.subscription_end).toLocaleDateString('ar-EG')
                                                                %>
                                                        </div>
                                                    </td>

                                                    <!-- Bonus Days -->
                                                    <td class="px-6 py-4 text-center">
                                                        <div class="text-lg font-black text-gold">
                                                            <%= salon.bonus_days || 0 %>
                                                        </div>
                                                    </td>

                                                    <!-- Actions -->
                                                    <td class="px-6 py-4">
                                                        <div class="flex flex-col gap-2">
                                                            <button
                                                                onclick="openGiftModal('<%= salon.id %>', '<%= salon.name %>')"
                                                                class="w-full px-4 py-2 bg-gold/10 text-gold rounded-xl font-bold hover:bg-gold/20 transition-all flex items-center justify-center gap-2">
                                                                <span
                                                                    class="material-symbols-outlined text-sm">card_giftcard</span>
                                                                <span>إهداء أيام</span>
                                                            </button>
                                                            <% if (!isExpired) { %>
                                                                <form action="/dashboard/admin/subscriptions/cancel"
                                                                    method="POST"
                                                                    onsubmit="return confirm('هل أنت متأكد من رغبتك في إلغاء اشتراك هذا الصالون؟');">
                                                                    <input type="hidden" name="salon_id"
                                                                        value="<%= salon.id %>">
                                                                    <button type="submit"
                                                                        class="w-full px-4 py-2 bg-red-500/10 text-red-500 rounded-xl font-bold hover:bg-red-500/20 transition-all flex items-center justify-center gap-2">
                                                                        <span
                                                                            class="material-symbols-outlined text-sm">cancel</span>
                                                                        <span>إلغاء الاشتراك</span>
                                                                    </button>
                                                                </form>
                                                                <% } %>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </main>
        </div>

        <!-- Gift Days Modal -->
        <div id="giftModal"
            class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 items-center justify-center p-4 hidden">
            <div
                class="bg-white dark:bg-[#2d1a22] rounded-3xl max-w-md w-full p-8 border-2 border-[#e6dbdf] dark:border-[#3d252e] shadow-2xl">
                <div class="text-center mb-6">
                    <div class="size-16 mx-auto bg-gold/10 rounded-2xl flex items-center justify-center mb-4">
                        <span class="material-symbols-outlined text-gold text-4xl">card_giftcard</span>
                    </div>
                    <h3 class="text-2xl font-black mb-2">إهداء أيام اشتراك</h3>
                    <p class="text-sm text-[#896170] dark:text-gray-400" id="salonNameDisplay"></p>
                </div>

                <form action="/dashboard/admin/subscriptions/gift" method="POST" class="space-y-6">
                    <input type="hidden" name="salon_id" id="giftSalonId">

                    <div>
                        <label class="block text-sm font-black mb-2">عدد الأيام</label>
                        <input type="number" name="days" min="1" max="365" required
                            class="w-full p-4 border-2 border-[#e6dbdf] dark:border-[#3d252e] rounded-2xl bg-gray-50 dark:bg-[#1a0c10] text-center text-3xl font-black"
                            placeholder="30">
                    </div>

                    <div>
                        <label class="block text-sm font-black mb-2">ملاحظة (اختياري)</label>
                        <textarea name="note" rows="3"
                            class="w-full p-4 border-2 border-[#e6dbdf] dark:border-[#3d252e] rounded-2xl bg-gray-50 dark:bg-[#1a0c10]"
                            placeholder="سبب الهدية..."></textarea>
                    </div>

                    <div class="flex gap-3">
                        <button type="button" onclick="closeGiftModal()"
                            class="flex-1 px-6 py-4 bg-gray-100 dark:bg-[#1a0c10] rounded-2xl font-black hover:bg-gray-200 dark:hover:bg-[#3d252e] transition-all">
                            إلغاء
                        </button>
                        <button type="submit"
                            class="flex-1 px-6 py-4 gradient-bg text-white rounded-2xl font-black shadow-lg hover:shadow-2xl transition-all shimmer">
                            إهداء الآن
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            function openGiftModal(salonId, salonName) {
                document.getElementById('giftSalonId').value = salonId;
                document.getElementById('salonNameDisplay').textContent = salonName;
                const modal = document.getElementById('giftModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            function closeGiftModal() {
                const modal = document.getElementById('giftModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            // Close modal on outside click
            document.getElementById('giftModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    closeGiftModal();
                }
            });
        </script>
</body>

</html>