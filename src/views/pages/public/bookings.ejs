<!DOCTYPE html>
<html class="light" dir="<%= (typeof locale !== 'undefined' ? locale : 'ar') === 'ar' ? 'rtl' : 'ltr' %>"
    lang="<%= typeof locale !== 'undefined' ? locale : 'ar' %>">

<head>
    <%- include('../../partials/head') %>
</head>

<body
    class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-[#1a0c10] dark:to-[#0d0507] text-[#181113] dark:text-white transition-colors duration-200">
    <%- include('../../partials/alerts') %>
        <div class="relative flex min-h-screen w-full flex-col">
            <%- include('../../partials/header') %>
                <main class="flex-1 flex flex-col w-full max-w-7xl mx-auto py-6 md:py-10 px-4">
                    <% const safeBookings=(typeof bookings !=='undefined' && Array.isArray(bookings)) ? bookings : [];
                        const pending=safeBookings.filter(b=> b.status === 'pending').length;
                        const confirmed = safeBookings.filter(b => b.status === 'confirmed').length;
                        const completed = safeBookings.filter(b => b.status === 'completed').length;
                        const cancelled = safeBookings.filter(b => b.status === 'cancelled').length;
                        const total = safeBookings.length;
                        %>

                        <!-- Header with Gradient -->
                        <div class="relative mb-8 overflow-hidden">
                            <div
                                class="absolute inset-0 bg-gradient-to-r from-primary/10 via-pink-500/10 to-purple-500/10 rounded-3xl blur-3xl">
                            </div>
                            <div
                                class="relative bg-white/80 dark:bg-[#2d1a22]/80 backdrop-blur-xl p-6 md:p-8 rounded-3xl border border-white/20 dark:border-white/10 shadow-2xl">
                                <div class="flex items-center gap-4">
                                    <div
                                        class="size-16 md:size-20 rounded-2xl bg-gradient-to-br from-primary via-pink-400 to-purple-400 flex items-center justify-center shadow-xl shadow-primary/30">
                                        <span
                                            class="material-symbols-outlined text-white text-3xl md:text-4xl">calendar_month</span>
                                    </div>
                                    <div class="flex-1">
                                        <h1
                                            class="text-3xl md:text-5xl font-black bg-gradient-to-r from-primary via-pink-500 to-purple-500 bg-clip-text text-transparent mb-2">
                                            حجوزاتي</h1>
                                        <p class="text-sm md:text-base text-[#896170] dark:text-gray-400 font-medium">
                                            تابعي
                                            مواعيدك وإدارة حجوزاتك بسهولة</p>
                                    </div>
                                    <% if (safeBookings.some(b=> b.status === 'completed' || b.status === 'cancelled'))
                                        { %>
                                        <button onclick="clearMyHistory()"
                                            class="mr-auto bg-red-500/10 text-red-600 px-4 py-2 rounded-xl font-bold flex items-center gap-2 hover:bg-red-500 hover:text-white transition-all text-xs">
                                            <span class="material-symbols-outlined text-sm">delete_sweep</span>
                                            <span class="hidden md:inline">مسح السجل</span>
                                        </button>
                                        <% } %>
                                </div>
                            </div>
                        </div>



                        <!-- Stats Grid -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 md:gap-4 mb-8">
                            <div class="bg-gray-900 dark:bg-white/10 p-5 rounded-2xl text-white">
                                <p class="text-3xl font-black">
                                    <%= total %>
                                </p>
                                <p class="text-xs opacity-60">الكل</p>
                            </div>
                            <div class="bg-yellow-400 p-5 rounded-2xl text-white">
                                <p class="text-3xl font-black">
                                    <%= pending %>
                                </p>
                                <p class="text-xs opacity-90">قيد الانتظار</p>
                            </div>
                            <div class="bg-blue-500 p-5 rounded-2xl text-white">
                                <p class="text-3xl font-black">
                                    <%= confirmed %>
                                </p>
                                <p class="text-xs opacity-90">مؤكدة</p>
                            </div>
                            <div class="bg-green-500 p-5 rounded-2xl text-white">
                                <p class="text-3xl font-black">
                                    <%= completed %>
                                </p>
                                <p class="text-xs opacity-90">مكتملة</p>
                            </div>
                            <div class="bg-red-500 p-5 rounded-2xl text-white">
                                <p class="text-3xl font-black">
                                    <%= cancelled %>
                                </p>
                                <p class="text-xs opacity-90">ملغية</p>
                            </div>
                        </div>

                        <!-- Filter Tabs -->
                        <div class="flex gap-2 mb-8 overflow-x-auto pb-2">
                            <button onclick="filterBookings('all')" id="all-tab"
                                class="filter-tab px-6 py-2 rounded-full bg-primary text-white font-bold text-sm shadow-lg">الكل</button>
                            <button onclick="filterBookings('active')" id="active-tab"
                                class="filter-tab px-6 py-2 rounded-full bg-white dark:bg-[#2d1a22] text-gray-600 dark:text-gray-400 font-bold text-sm border border-gray-200 dark:border-white/10">نشطة</button>
                            <button onclick="filterBookings('completed')" id="completed-tab"
                                class="filter-tab px-6 py-2 rounded-full bg-white dark:bg-[#2d1a22] text-gray-600 dark:text-gray-400 font-bold text-sm border border-gray-200 dark:border-white/10">مكتملة</button>
                            <button onclick="filterBookings('cancelled')" id="cancelled-tab"
                                class="filter-tab px-6 py-2 rounded-full bg-white dark:bg-[#2d1a22] text-gray-600 dark:text-gray-400 font-bold text-sm border border-gray-200 dark:border-white/10">ملغية</button>
                        </div>

                        <!-- Bookings List -->
                        <% if (safeBookings.length> 0) { %>
                            <div class="grid gap-4" id="bookings-container">
                                <% safeBookings.forEach(function(booking) { %>
                                    <div class="booking-card bg-white dark:bg-[#2d1a22] rounded-3xl p-6 border border-gray-200 dark:border-white/10 shadow-sm"
                                        data-status="<%= booking.status %>">
                                        <div class="flex flex-col md:flex-row gap-6">
                                            <!-- Date & Price -->
                                            <div
                                                class="flex md:flex-col items-center justify-between md:justify-center p-4 bg-gray-50 dark:bg-white/5 rounded-2xl md:w-32 text-center">
                                                <div>
                                                    <p class="text-4xl font-black text-primary">
                                                        <%= new Date(booking.booking_date).getDate() %>
                                                    </p>
                                                    <p class="text-xs font-bold text-gray-500">
                                                        <%= new Date(booking.booking_date).toLocaleDateString('ar-EG', {
                                                            month: 'short' }) %>
                                                    </p>
                                                </div>
                                                <div
                                                    class="h-px w-8 bg-gray-200 dark:bg-white/10 my-2 hidden md:block mx-auto">
                                                </div>
                                                <p class="text-xl font-black text-primary">
                                                    <%= booking.amount %> ج.م
                                                </p>
                                            </div>

                                            <!-- Info -->
                                            <div class="flex-1">
                                                <div class="flex items-center justify-between mb-4">
                                                    <div class="flex items-center gap-2">
                                                        <% if (booking.status==='confirmed' ) { %>
                                                            <span
                                                                class="px-3 py-1 bg-blue-100 text-blue-600 rounded-full text-[10px] font-black">مؤكد
                                                                ✅</span>
                                                            <% } else if (booking.status==='pending' ) { %>
                                                                <span
                                                                    class="px-3 py-1 bg-yellow-100 text-yellow-600 rounded-full text-[10px] font-black">قيد
                                                                    الانتظار ⏳</span>
                                                                <% } else if (booking.status==='completed' ) { %>
                                                                    <span
                                                                        class="px-3 py-1 bg-green-100 text-green-600 rounded-full text-[10px] font-black">مكتمل
                                                                        ✨</span>
                                                                    <% } else { %>
                                                                        <span
                                                                            class="px-3 py-1 bg-red-100 text-red-600 rounded-full text-[10px] font-black">ملغي
                                                                            ❌</span>
                                                                        <% } %>
                                                                            <span
                                                                                class="text-xs font-bold text-gray-400 dir-ltr text-right">
                                                                                <%= (booking.booking_time &&
                                                                                    booking.booking_time !=='00:00:00' )
                                                                                    ? booking.booking_time.slice(0, 5)
                                                                                    : '00:00' %>
                                                                            </span>
                                                    </div>
                                                </div>

                                                <h3 class="text-xl font-black mb-1">
                                                    <%= booking.salon_name %>
                                                </h3>
                                                <p class="text-sm text-[#896170] font-bold mb-4">
                                                    <%= booking.service_name || 'باقة العروس' %>
                                                </p>

                                                <% if (booking.status==='pending' || booking.status==='confirmed' ) { %>
                                                    <form action="/bookings/cancel/<%= booking.id %>" method="POST"
                                                        onsubmit="return confirm('هل أنتِ متأكدة من إلغاء هذا الحجز؟')">
                                                        <button type="submit"
                                                            class="text-red-500 text-sm font-bold flex items-center gap-1 hover:underline">
                                                            <span
                                                                class="material-symbols-outlined text-sm">cancel</span>
                                                            إلغاء الحجز
                                                        </button>
                                                    </form>
                                                    <% } else if (booking.status==='completed' ||
                                                        booking.status==='cancelled' ) { %>
                                                        <form action="/bookings/delete/<%= booking.id %>" method="POST"
                                                            onsubmit="return confirm('هل أنتِ متأكدة من حذف هذا السجل من قائمتكِ؟')">
                                                            <button type="submit"
                                                                class="text-gray-400 hover:text-red-500 text-sm font-bold flex items-center gap-1 transition-colors">
                                                                <span
                                                                    class="material-symbols-outlined text-sm">delete</span>
                                                                حذف من السجل
                                                            </button>
                                                        </form>
                                                        <% } %>
                                            </div>
                                        </div>
                                    </div>
                                    <% }); %>
                            </div>
                            <% } else { %>
                                <div
                                    class="text-center py-20 bg-white dark:bg-[#2d1a22] rounded-3xl border border-dashed border-gray-300">
                                    <p class="text-gray-400 font-bold">لا يوجد حجوزات حالياً</p>
                                    <a href="/salons"
                                        class="text-primary font-bold mt-4 inline-block hover:underline">استكشفي
                                        الصالونات</a>
                                </div>
                                <% } %>
                </main>
                <%- include('../../partials/footer') %>
        </div>

        <script>
            function filterBookings(status) {
                const cards = document.querySelectorAll('.booking-card');
                const tabs = document.querySelectorAll('.filter-tab');

                tabs.forEach(tab => {
                    tab.classList.remove('bg-primary', 'text-white', 'shadow-lg');
                    tab.classList.add('bg-white', 'dark:bg-[#2d1a22]', 'text-gray-600', 'dark:text-gray-400', 'border', 'border-gray-200', 'dark:border-white/10');
                });

                const activeTab = document.getElementById(status + '-tab');
                if (activeTab) {
                    activeTab.classList.add('bg-primary', 'text-white', 'shadow-lg');
                    activeTab.classList.remove('bg-white', 'dark:bg-[#2d1a22]', 'text-gray-600', 'dark:text-gray-400', 'border', 'border-gray-200', 'dark:border-white/10');
                }

                cards.forEach(card => {
                    const s = card.getAttribute('data-status');
                    if (status === 'all') card.style.display = 'block';
                    else if (status === 'active') card.style.display = (s === 'pending' || s === 'confirmed') ? 'block' : 'none';
                    else card.style.display = s === status ? 'block' : 'none';
                });
            }

            function clearMyHistory() {
                if (confirm('هل أنتِ متأكدة من مسح "سجل الحجوزات" المنتهية والملغية؟')) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/bookings/clear';
                    document.body.appendChild(form);
                    form.submit();
                }
            }
        </script>
</body>

</html>